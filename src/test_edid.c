
#include "sysobj.h"
#include "sysobj_foreach.h"
#include "sysobj_extras.h"
#include "util_sysobj.h"
#include "util_edid.h"
#include <unistd.h> /* for isatty() */

struct {
    char *tag;
    char *edid_data;
} test_data[] = {
{ "JVC",
"		00ffffffffffff002ac301001f000000\n"
"		1615010380522e780aa13ba3554a9b25\n"
"		10474aa5cf0001010101010101010101\n"
"		010101010101023a801871382d40582c\n"
"		450033cd3100001e000000fd00324d1f\n"
"		460f000a202020202020000000ff0031\n"
"		304142303131363030303031000000fc\n"
"		004a4c4333374243333030300a20013b\n"
"		020324714b010304059020151213141f\n"
"		29090705155750000000830100006503\n"
"		0c001000023a801871382d40582c5500\n"
"		33cd3100001e011d007251d01e206e28\n"
"		550033cd3100001e0000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		000000000000000000000000000000b4\n" },
{ "IBM",
"		00ffffffffffff00244d8e1900000000\n"
"		0a05010108281eb4c800b2a057499b26\n"
"		10484fa4cf7c314aa940a94aa94f8180\n"
"		010101010101100bd0b4205e6310126c\n"
"		6208fab80000001a000000ff00333039\n"
"		41424330303032350a20000000fe0054\n"
"		48495320495320410a202020000000fe\n"
"		00544553542c2054484520454e44008f\n" },
{ "Dell",
"		00ffffffffffff0010ac3b404d384730\n"
"		0e130103682f1e782eee95a3544c9926\n"
"		0f5054a54b00714f8180b30001010101\n"
"		01010101010121399030621a274068b0\n"
"		3600d9281100001c000000ff00483036\n"
"		39483934333047384d0a000000fc0044\n"
"		454c4c20323230385746500a000000fd\n"
"		00384b1e5310000a2020202020200095\n" },
{ "HP",
"		00ffffffffffff0022f0a82601010101\n"
"		2b110103682f1e78eeb535a5564a9a25\n"
"		105054a56b90710081409500a900b300\n"
"		01010101010121399030621a274068b0\n"
"		3600d9281100001c000000fd00304c18\n"
"		5210000a202020202020000000fc0048\n"
"		502077323230370a20202020000000ff\n"
"		00434e44373433334b50440a202000d8\n" },
{ "LGD Haruka",
"		00ffffffffffff0030e42f0500000000\n"
"		001a01049522137803a1c59459578f27\n"
"		20505400000001010101010101010101\n"
"		0101010101012e3680a070381f403020\n"
"		350058c210000019222480a070381f40\n"
"		3020350058c210000019000000fd0028\n"
"		3c43430e010a20202020202000000002\n"
"		000c47ff0a3c6e1c151f6e0000000018\n" },
{ "LGD Setsuna",
"		00ffffffffffff0030e4f70200000000\n"
"		00140103802615780a88a59d5f579c26\n"
"		1c505400000001010101010101010101\n"
"		0101010101012f2640a060841a303020\n"
"		35007ed7100000190000000000000000\n"
"		00000000000000000000000000fe004c\n"
"		4720446973706c61790a2020000000fe\n"
"		004c503137335744312d544c4e31000e\n" },
{ "LGD Pumbler",
"		00ffffffffffff0030e401d800000000\n"
"		00120103802213780ade05a35a519226\n"
"		1a505400000001010101010101010101\n"
"		0101010101013e1c56a0500016303020\n"
"		350058c2100000190000000000000000\n"
"		00000000000000000000000000fe004c\n"
"		4720446973706c61790a2020000000fe\n"
"		004c503135365748312d544c4331004f\n" },
/* https://www.headlessghost.com/res/Docs/NewerTech_headlessModule_EDIDReport_Public.pdf */
{ "EDID Data Report Example",
"		00FFFFFFFFFFFF003EE3020068636574\n"
"		1519010480502D780A0DC9A057479827\n"
"		12484CFFFF00D1C0D100D1CFD10FD1DE\n"
"		D11E0101010166E8FF98F1702A801090\n"
"		1300FF70F800001E000000FC004E5420\n"
"		484541444C4553530A20AB5E00A0A0A0\n"
"		2D501060B20000A0A500001EE8E30030\n"
"		F270328040C013000070F800001E01A5\n"
"		020356725F6B645820606804133E3C11\n"
"		02031506010708090A0B0C0D0E0F1216\n"
"		1718191A5F1B1C1D1E21232425262728\n"
"		292A2B2C2DAE2F303132333435363738\n"
"		393A3B3D423F406E030C001000393C2A\n"
"		00800102030432880030A2A0325040C0\n"
"		130000A0A5000000F56C0030A2A03250\n"
"		40C0130000A0A50000000000000000A5\n" },
{ "DisplayID Valve Index HMD",
"		00ffffffffffff000dcca89158e837b0\n"
"		ff1c0103800000780a4897a15b54a026\n"
"		134a5000000001010101010101010101\n"
"		01010101010100000010000000000000\n"
"		0000000000000000000000fc00496e64\n"
"		657820484d440a202020000000100000\n"
"		00000000000000000000000000000010\n"
"		00000000000000000000000000000172\n"
"		70121e000003011463af00803f0b4f00\n"
"		07001f003f0657004d00050081030423\n"
"		090401c0000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000090\n"
"		012345\n" }, /* some extra to test hex dumper */
{ "DisplayID crasher",
"		00ffffffffffff0034a996a20c800000\n"
"		00170104a59051780eee95a3544c9926\n"
"		0f505421080031404540614081800101\n"
"		0101010101010474801871705a80582c\n"
"		8a005d881100001e000000f7000a00c0\n"
"		80000000000000000000000000fc0050\n"
"		616e61736f6e69632d310a20000000fd\n"
"		00173d0f441e000a2020202020200260\n"
"		020319e144902022042309070168030c\n"
"		006000803c0fe2004b0474009880705a\n"
"		802c2c8a005d881100001e662156aa51\n"
"		001e30468f3300ba882100001e000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000065\n"
"		7012790000120016821000007f076f08\n"
"		000000000053544d9320020502050300\n"
"		14001d00c4ff0471016d002700cf021d\n"
"		0004000400030014001d00447f073d03\n"
"		7d022b0037042c000300040010010302\n"
"		05000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		0000000000000000000000000000a190\n" },/**/
{ "DisplayID with String",
"		00ffffffffffff004c2d430d00000001\n"
"		011a0103807944780a23ada4544d9926\n"
"		0f474abdef80714f81c0810081809500\n"
"		a9c0b300010104740030f2705a80b058\n"
"		8a00501d7400001e023a801871382d40\n"
"		582c4500501d7400001e000000fd0018\n"
"		4b0f511e000a202020202020000000fc\n"
"		0053414d53554e470a202020202002f3\n"
"		020340f0535f101f041305142021225d\n"
"		5e626364071603122309070783010000\n"
"		e2000fe30503016e030c002000b83c20\n"
"		108001020304e3060501e50e60616566\n"
"		011d80d0721c1620102c2580501d7400\n"
"		009e662156aa51001e30468f3300501d\n"
"		7400001e000000000000000000000000\n"
"		0000000000000000000000000000002e\n"
"		701124030003001407e80000ff0e2f02\n"
"		af8057006f085900078009000b000a53\n"
"		77697463685265735895000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000090\n" },
{ "Invalid Product Name",
"		00ffffffffffff0006af3d3300000000\n"
"		001a0104951f1178028d15a156529d28\n"
"		0a505400000001010101010101010101\n"
"		010101010101143780b8703824401010\n"
"		3e0035ae1000001a102c80b870382440\n"
"		10103e0035ae1000001a000000fe004b\n"
"		57385434804231343048414e00000000\n"
"		0000410196011100000a010a20200063\n" },
{ "(513) DisplayID block overrun",
"		00ffffffffffff00410c2a090c150000\n"
"		121d0104b57722783fdc41ac5047a526\n"
"		115054bfef00d1c08180010101010101\n"
"		0101010101011a6800a0f0381f403020\n"
"		3a00a9504100001a565e00a0a0a02950\n"
"		30203500a9504100001e000000fc0050\n"
"		484c2034393950390a202020000000fd\n"
"		00304be6e63c010a20202020202002a9\n"
"		020329f14b0103051404131f12021190\n"
"		230907078301000065030c001000e305\n"
"		e301e606070169691c023a801871382d\n"
"		40582c4500a9504100001ea073006aa0\n"
"		a0295008203500a9504100001a000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		000000000000000000000000000000ac\n"
"		701279000003013c33b70004ff139f00\n"
"		2f801f009f05280002000900bed60004\n"
"		ff139f002f801f009f052f0002000900\n"
"		555a0004ff139f002f801f009f051400\n"
"		02000900000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000790\n" },
{ "Apple, with DI-EXT",
"		00ffffffffffff00061021923e3f0102\n"
"		021201038040287828fe85a3574a9c25\n"
"		13505400000001010101010101010101\n"
"		010101010101bc1b00a0502017303020\n"
"		360081912100001ab06800a0a0402e60\n"
"		3020360081912100001a000000ff0043\n"
"		59383032304c4a584d500a00000000fc\n"
"		0043696e656d612048440a00000001da\n"
"		40010300000000c84801a500a5000102\n"
"		031919a8000000000000400000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000000\n"
"		00000000000000000000000000000041\n" },
};


static int fmt_opts_complete = FMT_OPT_NO_JUNK | FMT_OPT_COMPLETE;
static int fmt_opts_list = FMT_OPT_NO_JUNK | FMT_OPT_LIST_ITEM;

gboolean examine(sysobj *s, gpointer user_data, gconstpointer stats) {
    if (SEQ(s->name, "edid")) {
        sysobj_classify(s);
        sysobj_read(s, FALSE);
        gchar *nice_li = sysobj_format(s, fmt_opts_list);
        gchar *nice = sysobj_format(s, fmt_opts_complete);
        printf("\n-- %s --\n-[ %s ]-\n%s\n", s->path, nice_li, nice);

        edid *e = edid_new(s->data.any, s->data.len);
        if (e) {
            char *hexver = edid_dump_hex(e, 2, 1);
            printf("%s\n", hexver);
            g_free(hexver);
            edid_free(e);
        }

        g_free(nice_li);
        g_free(nice);

    }
    return SYSOBJ_FOREACH_CONTINUE;
}

int main(int argc, char **argv) {
    const gchar *altroot = NULL;

    if (argc >= 2) {
        altroot = argv[1];
    }

    if (isatty(fileno(stdout)) ) {
        fmt_opts_list |= FMT_OPT_ATERM;
        fmt_opts_complete |= FMT_OPT_ATERM;
    }

    sysobj_init(altroot);

    sysobj_foreach_from("/sys/devices", NULL, (f_sysobj_foreach)examine, NULL, SO_FOREACH_NORMAL);

    for(int i = 0; i < (int)G_N_ELEMENTS(test_data); i++) {
        edid *e = edid_new_from_hex(test_data[i].edid_data);
        char *out = V2_edid_dump(e->e2);
        printf("\n-- test_data[%d] %s --\n%s\n", i, test_data[i].tag, out);
        g_free(out);
        edid_free(e);
    }

    sysobj_cleanup();
    return 0;
}
